---
title: "UCLH bed needs modelling"
author: "Quentin Leclerc, Gwen Knight"
date: "01/04/2020"
output:
  bookdown::pdf_document2:
    fig_width: 5
    fig_height: 3.5
header-includes:
 \usepackage{float}
 \floatplacement{figure}{H}
 \floatplacement{table}{H}
 \usepackage[labelfont=bf]{caption}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(ggplot2)
library(dplyr)
library(reshape2)
library(bookdown)
library(knitr)
library(kableExtra)
source("beds_needed_uclh_functions.R")

#here specify the csv containing the predicted covid admission incidence
cov_curve_all = read.csv("data/200401_pietro_preds.csv")
colnames(cov_curve_all)[1] = "Date" #fix colnames

run_duration = max(cov_curve_all$day) #run duration in days
nruns = 500
params = list(
  # Pathways:
  #1: intubation (14 days ICU with 50% mortality, then 7 days HDU, then 14 days ward bed)
  prop_path1 = 0.18,
  ICU_mortality = 0.5,
  #2: no intubation (7 days HDU with 20% mortality, then 10 days ward)
  prop_path2 = 0.08,
  HDU_mortality = 0.2,
  
  # LoS:
  average_LoS_ICU = 14, #average LoS in ICU in days
  average_LoS_HDU = 7, #average LoS in HDU in days
  average_LoS_ward1 = 14, #average LoS in ward in days (pathway 1)
  average_LoS_ward2 = 10) #average LoS in ward in days (pathway 2)

```

# Model input

- Forecasted COVID19 hospital admissions, taking Pietro/Richard forecasts for 0% (base) / 20% / 40% / 50% / 60% / 73% reduction in contact rates (Figure \@ref(fig:covcurves))
- Patient pathways
    1) intubated (mechanical ventilation) – mean LoS assumption: 14 days in ICU (with 50% mortality), 7 days HDU, 14 days ward bed, then discharge
    2) not intubated (non-invasive ventilation/CPAP) – mean LoS assumption: 7 days HDU (with 20% mortality), 10 days ward, then discharge
- Proportion of admissions going in each pathway:
    1) `r params$prop_path1*100`%
    2) `r params$prop_path2*100`%
- Note: `r (1-params$prop_path1-params$prop_path2)*100`% of COVID19 admissions are not critical care, and go on another pathway straight to ward beds. This is not yet accounted for in the model.
- Mortality:
    1) 50% in ICU, for those admitted straight to ICU. Otherwise they survive to discharge at end of pathway
    2) 20% in HDU, for those admitted straight to HDU. Otherwise they survive to discharge at end of pathway

```{r covcurves, fig.cap="Forecasted daily COVID19 hospital admissions. Scenarios are: basic, 20% reduction in contact rate, and 60% reduction in contact rates."}

cov_curve_all %>%
  select(-day) %>%
  mutate(Date = as.Date(Date, format = "%d/%m/%Y")) %>%
  melt(., id.vars = "Date") %>%
  ggplot(.) +
  geom_line(aes(Date, value, group = variable, colour = variable)) +
  scale_colour_discrete(breaks = c("X0red", "X20red", "X40red", "X50red", "X60red", "X73red"),
                        labels = c("Basic (0%)", "20%", "40%", "50%", "60%", "73%"), "Reduction\nlevel") +
  labs(x = "Time (months)", y = "Forecasted number of COVID19 admissions", colour = "Scenario:") +
  theme_bw()

ggsave("outputs/scenarios.png")

```


# Model principle

This model simulates the next few weeks of the epidemic. Every day, we assume a fixed `r (params$prop_path1+params$prop_path2)*100`% (`r params$prop_path1*100`% + `r params$prop_path2*100`%) of forecasted COVID19 admissions require critical care. For each admission, we randomly draw the pathway based on the proportions provided as input. The model then simulates the length of stay for each step in the pathway for each patient.

For example, if a patient is admitted on day 1 and goes through pathway 1, we first randomly draw the length of stay in ICU from a Poisson distribution with mean `r params$average_LoS_ICU` days. We then establish whether that patient dies, based on the mortality in ICU (here, `r params$ICU_mortality*100`%). If the patient dies, we then sample the date of death based on a Uniform distribution from 0 to the sampled length of stay above, reduce the new length of stay accordingly, and record that a death has occured at that time. If the patient does not dies, he/she moves on to the next step of the pathway.

We repeat the process to draw a length of stay for each remaining step (type of bed occupancy) in turn on the pathway, systematically recording the time interval when a bed will be needed. This allows us to account for the fact that beds are only needed for a limited period of time, and will eventually become available again for other patients.


# Model output

The model outputs the number of beds that would be needed each day to accommodate all of the admitted critical care COVID19 patients. The model can be run multiple times to provide us a mean and error range for these outputs. The uncertainty presented arises from the stochastic model sampling from distributions in length of stays in each bed type, and from proportions to assign the pathways to each patient. 

Results from `r nruns` model runs for each of the 6 scenarios (base, 20%/40%/50%/60%/73% reduction) are presented below in summary Figures \@ref(fig:combicu), \@ref(fig:combhdu) and \@ref(fig:deaths), and summary Table \@ref(tab:Tsummary). More details for each scenario are given in Figures \@ref(fig:base), \@ref(fig:x20), \@ref(fig:x40), \@ref(fig:x50), \@ref(fig:x60) and \@ref(fig:x73), and Tables \@ref(tab:Tbase), \@ref(tab:Tx20), \@ref(tab:Tx40), \@ref(tab:Tx50), \@ref(tab:Tx60) and \@ref(tab:Tx73).

```{r gen_all, include=FALSE, cache = FALSE}
# cache option SAVES runs !

cov_curve = cov_curve_all$X0red
results_base = multi_uclh_model(nruns = nruns, cov_curve, params, run_duration)
results_base$date <- seq(as.Date("2020/3/7"), by = "days", length.out = length(results_base[,1]))

cov_curve = cov_curve_all$X20red
results_x20 = multi_uclh_model(nruns = nruns, cov_curve, params, run_duration)
results_x20$date <- seq(as.Date("2020/3/7"), by = "days", length.out = length(results_x20[,1]))

cov_curve = cov_curve_all$X40red
results_x40 = multi_uclh_model(nruns = nruns, cov_curve, params, run_duration)
results_x40$date <- seq(as.Date("2020/3/7"), by = "days", length.out = length(results_x40[,1]))

cov_curve = cov_curve_all$X50red
results_x50 = multi_uclh_model(nruns = nruns, cov_curve, params, run_duration)
results_x50$date <- seq(as.Date("2020/3/7"), by = "days", length.out = length(results_x50[,1]))

cov_curve = cov_curve_all$X60red
results_x60 = multi_uclh_model(nruns = nruns, cov_curve, params, run_duration)
results_x60$date <- seq(as.Date("2020/3/7"), by = "days", length.out = length(results_x60[,1]))

cov_curve = cov_curve_all$X73red
results_x73 = multi_uclh_model(nruns = nruns, cov_curve, params, run_duration)
results_x73$date <- seq(as.Date("2020/3/7"), by = "days", length.out = length(results_x73[,1]))

```


## Summary

```{r combicu, fig.cap="Output ICU bed demand from 500 model runs for the 20%, 40%, 50%, 60% and 73% reduction in contact rates. The horizontal lines represent the current maximum bed capacity. Lines are average daily requirements, shaded area represents average +/- standard deviation."}
ICU_capacity = 117

ggplot() +
  geom_line(data = results_base, aes(date, ICU_beds, colour = "1")) +
  geom_ribbon(data = results_base, aes(date, ymin = ICU_beds - ICU_beds_sd,
                                       ymax = ICU_beds + ICU_beds_sd, fill = "1"), alpha = 0.3) +
  geom_line(data = results_x20, aes(date, ICU_beds, colour = "2")) +
  geom_ribbon(data = results_x20, aes(date, ymin = ICU_beds - ICU_beds_sd,
                                      ymax = ICU_beds + ICU_beds_sd, fill = "2"), alpha = 0.3) +
  geom_line(data = results_x40, aes(date, ICU_beds, colour = "3")) +
  geom_ribbon(data = results_x40, aes(date, ymin = ICU_beds - ICU_beds_sd,
                                      ymax = ICU_beds + ICU_beds_sd, fill = "3"), alpha = 0.3) +
    geom_line(data = results_x50, aes(date, ICU_beds, colour = "4")) +
  geom_ribbon(data = results_x50, aes(date, ymin = ICU_beds - ICU_beds_sd,
                                      ymax = ICU_beds + ICU_beds_sd, fill = "4"), alpha = 0.3) +
    geom_line(data = results_x60, aes(date, ICU_beds, colour = "5")) +
  geom_ribbon(data = results_x60, aes(date, ymin = ICU_beds - ICU_beds_sd,
                                      ymax = ICU_beds + ICU_beds_sd, fill = "5"), alpha = 0.3) +
    geom_line(data = results_x73, aes(date, ICU_beds, colour = "6")) +
  geom_ribbon(data = results_x73, aes(date, ymin = ICU_beds - ICU_beds_sd,
                                      ymax = ICU_beds + ICU_beds_sd, fill = "6"), alpha = 0.3) +
  scale_colour_discrete(breaks = c("1", "2", "3","4","5","6"),
                        labels = c("Basic (0%)", "20%", "40%","50%","60%","73%"),"Reduction\nlevel") +
  labs(x = "Time (months)", y = "Beds needed", colour = "Scenario:") +
  guides(fill = FALSE) +
  ggtitle("ICU") + 
  theme_bw() + 
  geom_hline(aes(yintercept = ICU_capacity, colour = "ICU")) 

ggsave("outputs/ICU_beds_all.png")


```

```{r combhdu, fig.cap="Output HDU bed demand from 500 model runs for the 20%, 40%, 50%, 60% and 73% reduction in contact rates. The horizontal lines represent the current maximum bed capacity. Lines are average requirements, shaded area represents average +/- standard deviation."}

HDU_capacity = c(rep(0,20), # nothing until 27th March
                 rep(8,19), # 8 until 15th April
                 rep(116,20), # on 15th April until early May (5th?)
                 rep(155,length(cov_curve) - 59)) # jump to
hdf <- tibble(time = seq_along(HDU_capacity), capacity = HDU_capacity)
hdf$date <- results_base$date

ggplot() +
  geom_line(data = results_base, aes(date, HDU_beds, colour = "1")) +
  geom_ribbon(data = results_base, aes(date, ymin = HDU_beds - HDU_beds_sd,
                                       ymax = HDU_beds + HDU_beds_sd, fill = "1"), alpha = 0.3) +
  geom_line(data = results_x20, aes(date, HDU_beds, colour = "2")) +
  geom_ribbon(data = results_x20, aes(date, ymin = HDU_beds - HDU_beds_sd,
                                      ymax = HDU_beds + HDU_beds_sd, fill = "2"), alpha = 0.3) +
  geom_line(data = results_x40, aes(date, HDU_beds, colour = "3")) +
  geom_ribbon(data = results_x40, aes(date, ymin = HDU_beds - HDU_beds_sd,
                                      ymax = HDU_beds + HDU_beds_sd, fill = "3"), alpha = 0.3) +
    geom_line(data = results_x50, aes(date, HDU_beds, colour = "4")) +
  geom_ribbon(data = results_x50, aes(date, ymin = HDU_beds - HDU_beds_sd,
                                      ymax = HDU_beds + HDU_beds_sd, fill = "4"), alpha = 0.3) +
    geom_line(data = results_x60, aes(date, HDU_beds, colour = "5")) +
  geom_ribbon(data = results_x60, aes(date, ymin = HDU_beds - HDU_beds_sd,
                                      ymax = HDU_beds + HDU_beds_sd, fill = "5"), alpha = 0.3) +
    geom_line(data = results_x73, aes(date, HDU_beds, colour = "6")) +
  geom_ribbon(data = results_x73, aes(date, ymin = HDU_beds - HDU_beds_sd,
                                      ymax = HDU_beds + HDU_beds_sd, fill = "6"), alpha = 0.3) +
  scale_colour_discrete(breaks = c("1", "2", "3","4","5","6"),
                        labels = c("Basic (0%)", "20%", "40%","50%","60%","73%"),"Reduction\nlevel") +
  labs(x = "Time (months)", y = "Beds needed", colour = "Scenario:") +
  guides(fill = FALSE) +
  theme_bw() + 
  ggtitle("HDU") +
  geom_line(data = hdf, aes(x = date, y = capacity, colour = "HDU")) 

ggsave("outputs/HDU_beds_all.png")


```


```{r deaths, fig.cap="Estimated incidence of mortality in COVID19 hospitalised patients from 500 model runs. Scenarios are: 0% reduction in contact rate (base), 20%, 40%, 50%, 60% and 73% reduction in contact rates. Lines are average daily incidence, shaded area represents average +/- standard deviation."}

ggplot() +
  geom_line(data = results_base, aes(date, deaths, colour = "1")) +
  geom_ribbon(data = results_base, aes(date, ymin = deaths - deaths_sd,
                                       ymax = deaths + deaths_sd, fill = "1"), alpha = 0.3) +
  geom_line(data = results_x20, aes(date, deaths, colour = "2")) +
  geom_ribbon(data = results_x20, aes(date, ymin = deaths - deaths_sd,
                                      ymax = deaths + deaths_sd, fill = "2"), alpha = 0.3) +
  geom_line(data = results_x40, aes(date, deaths, colour = "3")) +
  geom_ribbon(data = results_x40, aes(date, ymin = deaths - deaths_sd,
                                      ymax = deaths + deaths_sd, fill = "3"), alpha = 0.3) +
    geom_line(data = results_x50, aes(date, deaths, colour = "4")) +
  geom_ribbon(data = results_x50, aes(date, ymin = deaths - deaths_sd,
                                      ymax = deaths + deaths_sd, fill = "4"), alpha = 0.3) +
    geom_line(data = results_x60, aes(date, deaths, colour = "5")) +
  geom_ribbon(data = results_x60, aes(date, ymin = deaths - deaths_sd,
                                      ymax = deaths + deaths_sd, fill = "5"), alpha = 0.3) +
    geom_line(data = results_x73, aes(date, deaths, colour = "6")) +
  geom_ribbon(data = results_x73, aes(date, ymin = deaths - deaths_sd,
                                      ymax = deaths + deaths_sd, fill = "6"), alpha = 0.3) +
  scale_colour_discrete(breaks = c("1", "2", "3","4","5","6"),
                        labels = c("Basic (0%)", "20%", "40%","50%","60%","73%"),"Reduction\nlevel") +
  labs(x = "Time (months)", y = "Incidence of COVID19 deaths in hospital", colour = "Scenario:") +
  guides(fill = FALSE) +
  scale_y_continuous(breaks = seq(0,120,10)) +
  theme_bw()

ggsave("outputs/deaths.png")


```



```{r Tsummary}

tab = table_multi(results_base, results_x20, results_x40, results_x50, results_x60, results_x73, save = T)
kable(tab, format = "latex", booktabs = T,
      caption = "Summary model output from 500 model runs for all scenarios. Scenarios are: 0\\% reduction in contact rate (base), 20\\%, 40\\%, 50\\%, 60\\% and 73\\% reduction in contact rates SD: standard deviation. Note that ward bed needs only represent the need for critical care patients, NOT the need for total COVID19 admissions.",
      col.names = c("Scenario",
                    "Peak time", "Mean beds", "SD",
                    "Peak time","Mean beds", "SD",
                    "Peak time","Mean beds", "SD",
                    "Mean deaths", "SD")) %>%
  kable_styling(latex_options = c("striped", "scale_down")) %>%
  add_header_above(c(" " = 1, "ICU peak bed needs" = 3, "HDU peak bed needs" = 3,
                     "Ward peak bed needs" = 3,"Cumulative deaths" = 2))

```

## Model Limitations

- Uncertainty in inputs: using a Poisson distribution for length of stay based on single mean values
- Simple pathways: patients can only follow one of two pathways with fixed length of stay
- Mortality is assumed to be randomly assigned and to occur at the end of the length of stay (may overestimate beds needed?)
- Unlimited bed capacity: this is a prediction of bed need and does not include any competition for beds
- Uncertainty presented reflects only uncertainty in length of stay 
- The population is split only by the two pathways - age / co-morbidities are not included
- Simple ward beds are only included for critical care patients, NOT for total COVID19 admissions, since we do not have an estimate of length of stay for patients admitted straight to ward beds


## Individual scenario plots and tables 

```{r base, fig.cap="Output from 500 model runs for the base scenario. The horizontal lines represent the current maximum bed capacity for the different units.Lines are average daily incidence, shaded area represents average +/- standard deviation."}

plot_multi(results_base, save = T, filename = "cov_pred_base")

```

```{r x20, fig.cap="Output from 500 model runs for the 20% reduction scenario. The horizontal lines represent the current maximum bed capacity for the different units. Lines are average daily incidence, shaded area represents average +/- standard deviation."}

plot_multi(results_x20, save = T, filename = "cov_pred_x20")

```

```{r x40, fig.cap="Output from 500 model runs for the 40% reduction scenario. The horizontal lines represent the current maximum bed capacity for the different units. Lines are average daily incidence, shaded area represents average +/- standard deviation."}

plot_multi(results_x40, save = T, filename = "cov_pred_x40")

```

```{r x50, fig.cap="Output from 500 model runs for the 50% reduction scenario. The horizontal lines represent the current maximum bed capacity for the different units. Lines are average daily incidence, shaded area represents average +/- standard deviation."}

plot_multi(results_x50, save = T, filename = "cov_pred_x50")

```

```{r x60, fig.cap="Output from 500 model runs for the 60% reduction scenario. The horizontal lines represent the current maximum bed capacity for the different units. Lines are average daily incidence, shaded area represents average +/- standard deviation."}

plot_multi(results_x60, save = T, filename = "cov_pred_x60")

```

```{r x73, fig.cap="Output from 500 model runs for the 73% reduction scenario. The horizontal lines represent the current maximum bed capacity for the different units. Lines are average daily incidence, shaded area represents average +/- standard deviation."}

plot_multi(results_x73, save = T, filename = "cov_pred_x73")

```


******


```{r Tbase}

results_base_tab = results_base %>%
  mutate_at(vars(ICU_beds:deaths_sd), round) %>%
  select(date, ICU_beds, ICU_beds_sd, HDU_beds, HDU_beds_sd,
         ward_beds, ward_beds_sd, deaths, deaths_sd)

knitr::kable(results_base_tab,
             caption = "Model output from 500 model runs for the base scenario. SD: standard deviation. Note that ward bed needs only represent the need for critical care patients, NOT the need for total COVID19 admissions.",
             col.names = c("Date",
                           "Bed needs", "SD",
                           "Bed needs", "SD",
                           "Bed needs", "SD",
                           "Average", "SD"),
             longtable = T, booktabs = T) %>%
  add_header_above(c(" " = 1, "ICU" = 2, "HDU" = 2, "Ward" = 2, "Deaths" = 2)) %>%
  kable_styling(latex_options = c("striped", "repeat_header"))

```


******


```{r Tx20}

results_x20_tab = results_x20 %>%
  mutate_at(vars(ICU_beds:deaths_sd), round) %>%
  select(date, ICU_beds, ICU_beds_sd, HDU_beds, HDU_beds_sd,
         ward_beds, ward_beds_sd, deaths, deaths_sd)

knitr::kable(results_x20_tab,
             caption = "Model output from 500 model runs for the 20\\% reduction scenario. SD: standard deviation. Note that ward bed needs only represent the need for critical care patients, NOT the need for total COVID19 admissions.",
             col.names = c("Date",
                           "Bed needs", "SD",
                           "Bed needs", "SD",
                           "Bed needs", "SD",
                           "Average", "SD"),
             longtable = T, booktabs = T) %>%
  add_header_above(c(" " = 1, "ICU" = 2, "HDU" = 2, "Ward" = 2, "Deaths" = 2)) %>%
  kable_styling(latex_options = c("striped", "repeat_header"))

```


******


```{r Tx40}

results_x40_tab = results_x40 %>%
  mutate_at(vars(ICU_beds:deaths_sd), round) %>%
  select(date, ICU_beds, ICU_beds_sd, HDU_beds, HDU_beds_sd,
         ward_beds, ward_beds_sd, deaths, deaths_sd)

knitr::kable(results_x40_tab,
             caption = "Model output from 500 model runs for the 40\\% reduction scenario. SD: standard deviation. Note that ward bed needs only represent the need for critical care patients, NOT the need for total COVID19 admissions.",
             col.names = c("Date",
                           "Bed needs", "SD",
                           "Bed needs", "SD",
                           "Bed needs", "SD",
                           "Average", "SD"),
             longtable = T, booktabs = T) %>%
  add_header_above(c(" " = 1, "ICU" = 2, "HDU" = 2, "Ward" = 2, "Deaths" = 2)) %>%
  kable_styling(latex_options = c("striped", "repeat_header"))

```


******


```{r Tx50}

results_x50_tab = results_x50 %>%
  mutate_at(vars(ICU_beds:deaths_sd), round) %>%
  select(date, ICU_beds, ICU_beds_sd, HDU_beds, HDU_beds_sd,
         ward_beds, ward_beds_sd, deaths, deaths_sd)

knitr::kable(results_x50_tab,
             caption = "Model output from 500 model runs for the 50\\% reduction scenario. SD: standard deviation. Note that ward bed needs only represent the need for critical care patients, NOT the need for total COVID19 admissions.",
             col.names = c("Date",
                           "Bed needs", "SD",
                           "Bed needs", "SD",
                           "Bed needs", "SD",
                           "Average", "SD"),
             longtable = T, booktabs = T) %>%
  add_header_above(c(" " = 1, "ICU" = 2, "HDU" = 2, "Ward" = 2, "Deaths" = 2)) %>%
  kable_styling(latex_options = c("striped", "repeat_header"))

```


******


```{r Tx60}

results_x60_tab = results_x60 %>%
  mutate_at(vars(ICU_beds:deaths_sd), round) %>%
  select(date, ICU_beds, ICU_beds_sd, HDU_beds, HDU_beds_sd,
         ward_beds, ward_beds_sd, deaths, deaths_sd)

knitr::kable(results_x60_tab,
             caption = "Model output from 500 model runs for the 60\\% reduction scenario. SD: standard deviation. Note that ward bed needs only represent the need for critical care patients, NOT the need for total COVID19 admissions.",
             col.names = c("Date",
                           "Bed needs", "SD",
                           "Bed needs", "SD",
                           "Bed needs", "SD",
                           "Average", "SD"),
             longtable = T, booktabs = T) %>%
  add_header_above(c(" " = 1, "ICU" = 2, "HDU" = 2, "Ward" = 2, "Deaths" = 2)) %>%
  kable_styling(latex_options = c("striped", "repeat_header"))

```


******


```{r Tx73}

results_x73_tab = results_x73 %>%
  mutate_at(vars(ICU_beds:deaths_sd), round) %>%
  select(date, ICU_beds, ICU_beds_sd, HDU_beds, HDU_beds_sd,
         ward_beds, ward_beds_sd, deaths, deaths_sd)

knitr::kable(results_x73_tab,
             caption = "Model output from 500 model runs for the 73\\% reduction scenario. SD: standard deviation. Note that ward bed needs only represent the need for critical care patients, NOT the need for total COVID19 admissions.",
             col.names = c("Date",
                           "Bed needs", "SD",
                           "Bed needs", "SD",
                           "Bed needs", "SD",
                           "Average", "SD"),
             longtable = T, booktabs = T) %>%
  add_header_above(c(" " = 1, "ICU" = 2, "HDU" = 2, "Ward" = 2, "Deaths" = 2)) %>%
  kable_styling(latex_options = c("striped", "repeat_header"))

```

